# Content Aggregator API

Решение тестового задания Avito tech.
Файл с тестовым заданием располагается в корне проекта и называется Task.txt.

Этот проект представляет собой микросервис для работы с балансом пользователей.

## Оглавление

- [Установка и использование](#установка-и-использование)
- [Структура проекта](#структура-проекта)
- [API Эндпоинты](#api-эндпоинты)
- [Docker](#docker)
- [Тестирование](#тестирование)

## Установка и использование

1. Клонируйте репозиторий:
    ```sh
    git clone https://github.com/RedHotChilliHead/avito_tech_balance.git
    cd avito_tech_balance
    ```

2. Установите зависимости:
    ```sh
    pip install -r requirements.txt
    ```

3. Запуск всех контейнеров:
    ```sh
    docker-compose up --build
    ```
Примечание: миграции применять не нужно, файл c дампом базы данных schema.sql хранится в директории initdb (в соответствии с техническим заданием).

Сервер будет доступен по адресу `http://127.0.0.1:8000`.

## Структура проекта

- urls.py (корневой): Конфигурация маршрутизации URL проекта, включая маршруты для административного интерфейса.
- urls.py (приложение): Конфигурация маршрутизации URL для приложения, включая маршруты для пользователей, переводов транзакций.
- models.py: Определения моделей для пользователей и транзакций.
- serializers.py: Определения сериализаторов для моделей, позволяющие преобразовывать данные между моделями и форматами JSON.
- views.py: Определения представлений для обработки запросов к API, включая создание, обновление, удаление и получение данных.
- tests.py: Тесты API-представлений.

## API Эндпоинты

### Метод создания пользователя

#### Описание

Метод создания пользователя, его баланс автоматически будет выставлен как 0.00 рублей.

#### URL

```http
`POST /balance/customers`
```

#### Пример запроса

```sh
curl -X POST -H 'Content-Type: application/json' -d '{"name":"Antonio Banderas"}' http://127.0.0.1:8000//balance/customers/
```

#### Пример ответа

```json
{"id":2,"name":"Antonio Banderas","balance":"0.00","valute":"RUB"}
```

### Метод отображения списка пользователей

#### Описание

Метод отображения списка пользователей, валюта по умолчанию указана в рублях.

#### URL

```http
`GET /balance/customers`
```

#### Пример запроса

```sh
curl -X GET http://127.0.0.1:8000/balance/customers/
```

#### Пример ответа

```json
{"count":2,"next":null,"previous":null,"results":[{"id":1,"name":"Irina","balance":"0.00","valute":"RUB"},{"id":2,"name":"Antonio Banderas","balance":"0.00","valute":"RUB"}]}
```

### Метод отображения детальной информации о пользователе

#### Описание

Метод отображения детальной информации о пользователе, такой как id, имя, баланс, валют (по умолчанию указана в рублях).
Для вывода баланса в других валютах необходимо использовать параметр запроса currency и кодовое обозначение валюты.
Курс валюты будет актуальным на текущую дату относительно рубля, данные о курсе валют берутся с официального сайта Центрабльного Банка России http://www.cbr.ru/.

#### URL

```http
`GET /balance/customers/<int:id>`
```

#### Пример запроса

```sh
curl -X GET 'http://127.0.0.1:8000/balance/customers/1/?currency=USD'
```

#### Пример ответа

```json
{"id":1,"name":"Irina","balance":"0.00","valute":"USD"}
```

### Метод редактирования информации о пользователе

#### Описание

Метод редактирования информации о пользователе позволяет изменить имя, но не баланс.

#### URL

```http
`PUT /balance/customers/<int:id>`
```

#### Пример запроса

```sh
curl -X PUT -H 'Content-Type: application/json' -d '{"name":"Natalia Oreiro"}' http://127.0.0.1:8000//balance/customers/1/
```

#### Пример ответа

```json
{"id":1,"name":"Natalia Oreiro","balance":"0.00","valute":"RUB"}
```

### Метод удаления пользователя

#### Описание

Метод позволяет удалить пользователя из базы данных

#### URL

```http
`DELETE /balance/customers/<int:id>`
```

#### Пример запроса

```sh
curl -X DELETE http://127.0.0.1:8000//balance/customers/1/
```

#### Успешным выполнением метода удаления пользователя является пустой ответ


### Метод зачисления и снятия средств

#### Описание

Метод позволяет зачислить средства на счет пользователя и списать. Для данного метода не обязательно указывать источник зачисления средств и получателя в случае списания,
так как скорее всего в первом случае источником будет банк, а во втором получателем является платформа Avito.
В теле запроса требуется указать несколько обязательных параметров, такие как 'amount' (сумма), 'operation' (тип операции) и не обязательный параметр 'description' (описание).
В качестве типа операции должен быть выбран один из двух вариантов: 'withdraw' (зачисление средств на счет) или 'deposit' (списание средств).
В случае передачи некорректных параметров будет выведено соответствующее сообщение об ошибке.

#### URL

```http
`POST /balance/customers/<int:customer_id>/operations/`
```

#### Пример запроса

```sh
curl -X POST -H 'Content-Type: application/json' -d '{"amount": 1000000, "operation": "withdraw", "description": "for a new car"}' http://127.0.0.1:8000//balance/customers/2/operations/
```

#### Пример ответа

```json
{"OK":"The operation was successful"}
```

### Метод перевода средств одного пользователя на счет другого пользователя

#### Описание

Метод позволяет перевести средства одного пользователя на счет другого.

Для данного метода необходимо явно указать идентификатор отправителя и получателя средств.
В теле запроса должны быть следующие обязательные параметры: 'amount' (сумма), 'sender' (отправитель), 'recipient' (получатель)' и не обязательный параметр 'description' (описание).
В случае передачи некорректных параметров будет выведено соответствующее сообщение об ошибке.


#### URL

```http
`POST /balance/transfer/`
```

#### Пример запроса

```sh
curl -X POST -H 'Content-Type: application/json' -d '{"amount": 500, "sender": "2", "recipient": "3", "description": "present"}' http://127.0.0.1:8000//balance/transfer/
```

#### Пример ответа

```json
{"OK":"The operation was successful"}
```

### Метод отображения списка транзакций

#### Описание

Во время любого перевода, зачисления или снятия средств создается запись о транзакции.
Данный метод позволяет отобразить список транзакций конкретного пользователя.
Для упрощения навигации пользователя по списку транзакций была реализована возможность сортировки по дате и сумме.
Для сортировки по дате необходимо указать параметр запроса ?order=timestamp, для сортировки по сумме ?order=amount.
Для сортировки по убыванию параметр запроса должен начинаться с "-", например ?order=-amount
В случае передачи некорректных параметров будет выведено соответствующее сообщение об ошибке.


#### URL

```http
`GET /balance/customers/<int:customer_id>/transactions/`
```

#### Пример запроса

```sh
curl -X GET "http://127.0.0.1:8000//balance/customers/2/transactions/?order=-amount"
```

#### Пример ответа

```json
{
  "count":2,
  "next":null,
  "previous":null,
  "results":
  [
    {
      "id":1,
      "amount":"1000000.00",
      "timestamp":"2024-07-26T08:46:04.236372Z",
      "description":"for a new car",
      "sender":null,
      "recipient":2
    },
    {
      "id":2,
      "amount":"500.00",
      "timestamp":"2024-07-26T08:56:15.465247Z",
      "description":"present",
      "sender":2,
      "recipient":3
    }
  ]
}
```

## Docker

Проект использует Docker для контейнеризации. Основные команды:

- Запуск всех контейнеров:
    ```sh
    docker-compose up --build
    ```
  
- Запуск всех контейнеров в режиме демона:
    ```sh
    docker-compose up -d
    ```

- Остановка всех контейнеров:
    ```sh
    docker-compose down
    ```

- Создание и удаление тома для базы данных PostgreSQL:
    ```sh
    docker volume create balance_postgres_data
    docker volume rm balance_postgres_data
    ```

## Тестирование

Проект содержит тесты для проверки функциональности API.
Тесты можно запускать следующей командой:

```sh
docker-compose run test
```